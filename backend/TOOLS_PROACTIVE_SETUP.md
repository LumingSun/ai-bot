# 工具集成和主动互动系统配置说明

## 概述

第三阶段实现了完整的工具集成和主动互动系统，为宠物Agent提供了强大的功能扩展能力。

## 工具系统

### 核心工具

1. **TimeTool（时间工具）**
   - `get_current_time()`: 获取当前时间信息
   - `get_time_greeting()`: 根据时间生成问候语
   - 支持时间段判断（早上、下午、晚上、深夜）

2. **WeatherTool（天气工具）**
   - `get_weather()`: 获取天气信息（模拟数据）
   - `get_weather_mood()`: 根据天气生成心情描述
   - 支持多个城市的天气查询

3. **ReminderTool（提醒工具）**
   - `add_reminder()`: 添加提醒
   - `get_reminders()`: 获取所有提醒
   - `complete_reminder()`: 完成提醒
   - 支持提醒的完整生命周期管理

4. **HealthTool（健康工具）**
   - `get_health_status()`: 获取健康状态
   - `feed_pet()`: 喂食宠物
   - `play_with_pet()`: 和宠物玩耍
   - `update_health()`: 更新健康状态（随时间衰减）

### 工具管理器

**ToolManager** 统一管理所有工具：

```python
tool_manager = ToolManager()
result = tool_manager.execute_tool("get_time")
```

**可用工具列表**：
- `get_time`: 获取时间信息
- `get_weather`: 获取天气信息
- `add_reminder`: 添加提醒
- `get_reminders`: 获取提醒列表
- `complete_reminder`: 完成提醒
- `get_health`: 获取健康状态
- `feed_pet`: 喂食宠物
- `play_with_pet`: 和宠物玩耍

## 主动互动系统

### 系统架构

**ProactiveSystem** 提供智能的主动互动能力：

1. **事件类型**
   - `time_greeting`: 时间问候
   - `health_check`: 健康检查
   - `weather_comment`: 天气评论
   - `reminder_check`: 提醒检查
   - `lonely_check`: 孤独检查
   - `energy_check`: 精力检查

2. **触发条件**
   - 时间条件：特定时间点触发
   - 冷却时间：防止频繁触发
   - 性格适配：根据宠物性格调整频率

3. **事件处理器**
   - 每个事件类型有专门的处理函数
   - 根据性格生成个性化消息
   - 支持工具调用和状态更新

### 主动事件详解

#### 1. 时间问候 (time_greeting)
- **触发时间**: 8:00, 12:00, 18:00, 22:00
- **冷却时间**: 1小时
- **性格适配**:
  - 粘人型: "早上好主人！想死你了~"
  - 高冷型: "早上好，你来了。"
  - 活泼型: "早上好主人！新的一天开始啦！✨"
  - 安静型: "早上好..."

#### 2. 健康检查 (health_check)
- **触发频率**: 每30分钟
- **检查项目**: 饥饿度、快乐度
- **响应策略**:
  - 饥饿 > 80%: 请求喂食
  - 快乐 < 50%: 请求陪伴

#### 3. 天气评论 (weather_comment)
- **触发时间**: 7:00, 19:00
- **冷却时间**: 2小时
- **天气适配**: 根据天气状况生成评论

#### 4. 提醒检查 (reminder_check)
- **触发频率**: 每15分钟
- **功能**: 检查待办提醒并通知用户

#### 5. 孤独检查 (lonely_check)
- **性格适配**:
  - 粘人型: 经常检查，表达思念
  - 高冷型: 很少检查，简短回应
  - 其他: 中等频率

#### 6. 精力检查 (energy_check)
- **触发频率**: 每20分钟
- **功能**: 监控精力状态，必要时提醒休息

## API端点

### 工具相关端点

1. **POST /tools/execute**
   - 执行指定工具
   - 参数: `tool_name`, 其他工具特定参数
   - 返回: 工具执行结果

2. **GET /tools/available**
   - 获取可用工具列表
   - 返回: 工具名称数组

### 主动互动相关端点

1. **POST /proactive/trigger**
   - 手动触发主动事件
   - 参数: `event_type`
   - 返回: 事件消息

2. **POST /proactive/start**
   - 启动主动互动系统
   - 返回: 启动状态

3. **POST /proactive/stop**
   - 停止主动互动系统
   - 返回: 停止状态

## 集成工作流

### LangGraph工作流升级

在原有的工作流基础上添加了工具执行节点：

```
START
  ↓
analyze_input
  ↓
generate_response
  ↓
tool_execution  ← 新增
  ↓
update_mood
  ↓
check_energy
  ↓
END
```

### 工具执行逻辑

1. **输入分析**: 检测用户输入中的工具关键词
2. **工具匹配**: 根据关键词选择合适的工具
3. **工具执行**: 调用相应的工具函数
4. **结果处理**: 将工具结果添加到上下文
5. **状态更新**: 更新宠物状态

### 支持的工具关键词

- **时间相关**: "时间", "几点", "现在"
- **天气相关**: "天气", "温度", "下雨"
- **健康相关**: "健康", "状态", "怎么样"
- **提醒相关**: "提醒", "待办", "任务"
- **喂食相关**: "喂食", "吃饭", "饿了"
- **玩耍相关**: "玩耍", "玩", "游戏"

## 测试和调试

### 运行测试

```bash
cd backend
python test_tools_proactive.py
```

### 测试内容

1. **工具系统测试**
   - 各工具功能验证
   - 工具执行结果检查
   - 错误处理测试

2. **主动互动系统测试**
   - 不同性格的事件处理
   - 事件触发条件验证
   - 消息生成测试

3. **API端点测试**
   - 工具执行API
   - 主动事件触发API
   - 系统控制API

4. **集成工作流测试**
   - 包含工具的消息处理
   - 工作流执行验证
   - 状态更新检查

## 性能优化

### 工具执行优化

1. **缓存机制**: 缓存常用工具结果
2. **异步执行**: 支持异步工具调用
3. **错误恢复**: 工具执行失败时的降级处理

### 主动互动优化

1. **事件优先级**: 根据重要性排序事件
2. **智能调度**: 避免事件冲突
3. **资源管理**: 合理控制系统资源使用

## 扩展功能

### 计划中的扩展

1. **更多工具**
   - 音乐工具：播放音乐
   - 新闻工具：获取新闻
   - 翻译工具：语言翻译

2. **高级主动互动**
   - 学习能力：记住用户偏好
   - 情感识别：识别用户情绪
   - 个性化推荐：基于历史推荐活动

3. **MCP Server集成**
   - 外部工具调用
   - 系统集成能力
   - 跨平台功能

## 故障排除

### 常见问题

1. **工具执行失败**
   - 检查工具参数
   - 验证工具依赖
   - 查看错误日志

2. **主动事件不触发**
   - 检查时间条件
   - 验证冷却时间
   - 确认系统状态

3. **API连接失败**
   - 检查服务状态
   - 验证端口配置
   - 确认网络连接

### 调试技巧

1. **启用详细日志**
2. **逐步执行测试**
3. **检查状态变化**
4. **验证工具结果**

## 下一步计划

1. **MCP Server集成**
   - 实现MCP协议
   - 集成外部工具
   - 支持系统调用

2. **高级功能**
   - 多模态交互
   - 情感识别
   - 学习能力

3. **性能优化**
   - 并发处理
   - 内存优化
   - 响应速度提升 